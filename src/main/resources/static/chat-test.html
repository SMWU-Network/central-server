<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>IoT Chat</title>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f7f7f7;
            display: flex;
            justify-content: center;
            padding-top: 40px;
        }

        .chat-container {
            width: 380px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
            overflow: hidden;
        }

        .header {
            background: #4a90e2;
            color: white;
            padding: 14px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        .room-select {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .room-select input, .room-select select {
            padding: 6px 10px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        #chat-box {
            height: 350px;
            overflow-y: auto;
            padding: 12px;
            background: #fafafa;
            display: flex;
            flex-direction: column;
        }

        .msg-row {
            display: flex;
            margin-bottom: 10px;
        }

        .bubble {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.3;
            word-break: break-word;
        }

        /* 왼쪽 */
        .left { justify-content: flex-start; }

        /* 오른쪽 */
        .right { justify-content: flex-end; }

        /* sender별 색상 */
        .children { background: #e3f2fd; }
        .center   { background: #ffe0b2; }
        .system   { background: #d1c4e9; }
        .me       { background: #c8e6c9; }

        .input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
            background: #fff;
        }

        #msg {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        button {
            padding: 10px 14px;
            margin-left: 8px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #357ABD;
        }
    </style>
</head>

<body>
<div class="chat-container">

    <div class="header">IoT 실시간 상담 채팅</div>

    <div class="room-select">
        <input id="device" value="senior-5000" style="width: 140px;">
        <select id="sender">
            <option value="children">자녀</option>
            <option value="center">상담원</option>
        </select>
        <button onclick="changeDevice()">변경</button>
    </div>

    <div id="chat-box"></div>

    <div class="input-area">
        <input id="msg" placeholder="메시지를 입력하세요…">
        <button onclick="sendMsg()">Send</button>
    </div>
</div>

<script>
    let stomp = null;
    let subscription = null;

    function appendMessage(sender, message, isMine = false) {
        const box = document.getElementById("chat-box");

        const row = document.createElement("div");
        row.className = "msg-row " + (isMine ? "right" : "left");

        const bubble = document.createElement("div");
        bubble.className = "bubble " + sender;
        bubble.innerText = message;

        row.appendChild(bubble);
        box.appendChild(row);
        box.scrollTop = box.scrollHeight;
    }

    function connect() {
        const socket = new SockJS("http://localhost:8080/ws");
        stomp = Stomp.over(socket);

        stomp.connect({}, () => {
            subscribeToRoom(document.getElementById("device").value);
        });
    }

    function subscribeToRoom(deviceId) {
        if (subscription) subscription.unsubscribe();
        document.getElementById("chat-box").innerHTML = "";

        subscription = stomp.subscribe("/topic/chat/" + deviceId, (msg) => {
            const body = JSON.parse(msg.body);

            const sender = (body.sender ?? "system").toLowerCase();
            const currentUser = document.getElementById("sender").value;

            appendMessage(sender,
                body.message,
                sender === currentUser);  // 내가 보낸 건 오른쪽 정렬
        });
    }

    function changeDevice() {
        subscribeToRoom(document.getElementById("device").value);
    }

    function sendMsg() {
        const deviceId = document.getElementById("device").value;
        const sender = document.getElementById("sender").value;
        const msg = document.getElementById("msg").value;

        stomp.send("/app/chat/" + deviceId, {}, JSON.stringify({
            sender: sender,
            message: msg
        }));

        document.getElementById("msg").value = "";
    }

    connect();
</script>

</body>
</html>